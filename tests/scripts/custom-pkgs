#!/usr/bin/env bash

function skip {
    grep -v "te-unstable" |
    grep -v "haskellPackages"
}

# Get the package to test from our invocation name
PKG=$(basename "$0" | cut -c 12-)

ERR=0
if [[ -z "$PKG" ]]
then
    # No package given, make sure we have all of them

    # All config.nix definitions should have a test
    while read -r PKG
    do
        echo "Checking '$PKG'"
        [[ -e "scripts/custom-pkg.$PKG" ]] || {
            echo "'$PKG' doesn't have a test" >> /dev/stderr
            ERR=1
        }
    done < <(grep -v " *#" < ~/.nixpkgs/config.nix |
                    grep "^    [^ ].*="                   |
                    sed -e 's/^ *\([^ ][^=]*\)=.*/\1/g'   |
                    skip)

    # All tests must correspond to a config.nix definition
    for SCRIPT in scripts/custom-pkg.*
    do
        echo "Checking '$SCRIPT'"
        PKG=$(basename "$SCRIPT" | cut -c 12-)
        FOUND=$(nix-instantiate \
                    --eval \
                    --expr "let pkgs = import <nixpkgs> {}; in pkgs ? $PKG")
        [[ "x$FOUND" = "xtrue" ]] || {
            echo "'$PKG' doesn't seem to be a package" >> /dev/stderr
            ERR=1
        }
    done
    exit "$ERR"
else
    # Got a package, check it
    if ! nix-shell -p "$PKG" --run true
    then
        echo "Couldn't invoke nix-shell for '$PKG'" >> /dev/stderr
        exit 1
    fi
fi
