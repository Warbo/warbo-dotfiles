#!/usr/bin/env bash

shopt -s nullglob

function data {
    # When a test suite passes, it should store its coverage report here
    find ~/Programming/coverage -name "hpc_index.html"
}

function cached {
    ./helpers/cache.sh "hpc-coverage" < <(data)
}

# Prime the cache
cached > /dev/null
mkdir -p ~/Programming/coverage

# Check how we were called
if NAME=$(./helpers/getName.sh "$0")
then
    LINES=$(./helpers/checkNames.sh "$NAME" < <(cached)) || exit 1
    while read -r LINE
    do
        TOTAL='th[contains(text(),"Program Coverage Total")]'
        PERCENT='following-sibling::td[1]/text()'
        RESULT=$(xidel - --extract "//${TOTAL}/${PERCENT}" < "$LINE" | tr -d '%')
        if echo "$RESULT" | grep "[^0-9]" > /dev/null
        then
            # 0 shows up as "-", so fix it
            RESULT=0
        fi
        if [[ "$RESULT" -lt "30" ]]
        then
            echo "'$RESULT' coverage for '$LINE'" >> /dev/stderr
            exit 1
        fi
    done < <(echo "$LINES")
else
    ./helpers/namesMatch.sh "hpc-coverage" < <(cached) || exit 1
fi
