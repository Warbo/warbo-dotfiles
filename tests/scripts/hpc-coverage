#!/usr/bin/env bash

function data {
    while read -r DIR
    do
        [[ -d "$DIR/dist" ]] || continue
        find "$DIR/dist" -name "hpc_index.html"
    done < <(my_haskell)
}

function cached {
    ./helpers/cache.sh "hpc-coverage" < <(data)
}

cached > /dev/null

# Check how we were called
if FILE=$(./helpers/nthLine.sh "$0" "hpc-coverage")
then
    echo "Checking $FILE" >> /dev/stderr
    TOTAL='th[contains(text(),"Program Coverage Total")]'
    PERCENT='following-sibling::td[1]/text()'
    RESULT=$(xidel - --extract "//${TOTAL}/${PERCENT}" < "$FILE" | tr -d '%')
    if [[ "$RESULT" -lt "70" ]]
    then
        echo "'$RESULT' coverage for '$FILE'" >> /dev/stderr
        exit 1
    fi
else
    # No index given, check indices match up
    ./helpers/checkCache.sh "hpc-coverage" < <(cached)
fi
