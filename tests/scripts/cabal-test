#!/usr/bin/env bash

function data {
    while read -r CBL
    do
        if grep "test-suite" < "$CBL" > /dev/null
        then
            echo "$CBL"
        fi
    done < <(locate "/home/chris/Programming/*.cabal" |
             grep -v "/git-html/"                     |
             grep -v "/ghc/")
}

CACHE="results/data/cabal-test"
function cached {
    mkdir -p $(dirname "$CACHE")
    if [[ -e "$CACHE" ]] && test $(find "$CACHE" -mmin -60)
    then
        cat "$CACHE"
    else
        data | tee "$CACHE"
    fi
}

IDX=$(basename "$0" .cabal-test)
if [[ "x$IDX" = "xcabal-test" ]]
then
    # No index give, check indices match up
    CACHECOUNT=$(cached | wc -l)
    FILECOUNT=$(ls scripts/*.cabal-test | wc -l)
    if [[ "$CACHECOUNT" -eq "$FILECOUNT" ]]
    then
        echo "Got enough tests to cover cabal-test counts"
    else
        echo "Have $FILECOUNT test(s) for $CACHECOUNT files" >> /dev/stderr
        exit 1
    fi
else
    CBL=$(cached | tail -n"$IDX" | head -n1)
    echo "Testing '$CBL'"
    DIR=$(dirname "$CBL")
    FILE=$(basename "$CBL")
    cd "$DIR"

    if ! hsConfig
    then
        fail "hsConfig in '$DIR'"
        exit 1
    fi

    ERR=0
    while read -r TEST
    do
        cabal test "$TEST" || {
            echo "Test suite '$TEST' in '$DIR' failed" >> /dev/stderr
            ERR=1
        }
    done < <(grep "test-suite" < "$FILE" | sed -e 's/^test-suite *\(.*\)$/\1/g')
    exit "$ERR"
fi
