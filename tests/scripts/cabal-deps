#! /usr/bin/env nix-shell
#! nix-shell -p haskellPackages.packunused -p bash -i bash
exit 1
function fail {
    echo "$1" >> /dev/stderr
    ERR=1
}

ERR=0
while read -r DIR
do
    cd "$DIR"
    rm -rf dist/
    if ! hsConfig
    then
        fail "hsConfig in '$DIR'"
        continue
    fi

    rm -f *.imports
    if ! cabal build --ghc-options="-ddump-minimal-imports"
    then
        fail "cabal build in '$DIR'"
        continue
    fi

    if ! packunused
    then
        fail "packunused in '$DIR'"
    fi
done < <(my_haskell)

exit "$ERR"
