#! /usr/bin/env nix-shell
#! nix-shell -p ghcTurtle -p haskellPackages.hlint -i runhaskell
{-# LANGUAGE OverloadedStrings #-}

import Data.List
import Data.Maybe
import Filesystem.Path.CurrentOS hiding (empty)
import Prelude hiding (FilePath)
import Turtle

-- Run hlint on (almost) everything in ~/Programming/Haskell

-- Skip other people's projects which we can't fix
skipDirs = ["AI", "tip-tools", "Botworld", "IsaHipster", "AlgorithmsAndAI",
            "hipspec", "LazySmallCheck2012", "hbmc", "quickspec",
            "lambdapi", "hip", "ghc", "structural-induction", "ebc",
            "unification", "LC"]

keepDir :: FilePath -> Bool
keepDir x = not $ any (`elem` skipDirs) (splitDirectories x)

keepFile :: FilePath -> Bool
keepFile x = extension x `elem` [Just "hs", Just "lhs"]

hsDirs :: Shell FilePath
hsDirs = do x <- ls "/home/chris/Programming/Haskell"
            d <- testdir  x
            f <- testfile x
            if (d && keepDir x) || (f && keepFile x)
               then return x
               else empty

main = sh $ do
  d <- hsDirs
  proc "hlint" ["-XNoCPP", pathText d] empty

pathText = fromString . encodeString
