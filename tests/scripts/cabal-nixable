#!/usr/bin/env bash

function data {
    while read -r PROJECT
    do
        find "$PROJECT" -maxdepth 1 -name "*.cabal"
    done < <(my_haskell)
}

function cached {
    ./helpers/cache.sh "cabal-nixable" < <(data)
}

# Check how we were called

if IDX=$(./helpers/getIndex.sh "$0" cabal-nixable)
then
    FILE=$(cached | tail -n"$IDX" | head -n1)
    echo "Trying $FILE"
    DIR=$(dirname "$FILE")
    cd "$DIR"
    cabal clean
    hsConfig || exit 1
else
    # No index given, check indices match up
    CACHECOUNT=$(cached | wc -l)
    FILECOUNT=$(ls scripts/*.cabal-nixable | wc -l)
    if [[ "$CACHECOUNT" -eq "$FILECOUNT" ]]
    then
        echo "Got enough tests to cover cabal counts"
    else
        echo "Have $FILECOUNT test(s) for $CACHECOUNT files" >> /dev/stderr
        exit 1
    fi
fi
